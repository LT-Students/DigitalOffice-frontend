<mat-card class="card">
	<div class="header h3">
        <do-title-datepicker text="Статистика за" (onSelectedDate)="chosenMonthHandler($event)"></do-title-datepicker>
    </div>
	<ng-container *ngIf="employees$ | async as employees; else loader">
		<table class="table">
			<colgroup>
				<col class="column column_width_m" />
				<col class="column column_width_sm" />
				<col class="column column_width_sm" />
				<col class="column column_width_sm" />
				<col class="column column_width_t" />
			</colgroup>
			<thead class="text-gray1">
				<tr>
					<th>Имя</th>
					<th>Часы за проект/Норма</th>
					<th>Отсутствия</th>
					<th>Кол-во проектов</th>
					<th></th>
				</tr>
			</thead>
			<tbody [formGroup]="hoursGroup">
				<ng-container *ngFor="let employee of employees">
					<tr [ngClass]="{ row: !employee.editMode }">
						<td class="cell avatar">
							<do-profile-image class="avatar__photo"></do-profile-image>
							<div>
								<div>{{ employee?.firstName }} {{ employee?.lastName }}</div>
								<div>{{ employee?.position }}</div>
							</div>
						</td>
						<td class="cell">
							<div class="cell__hours">
								<ng-container *ngIf="!employee?.editMode; else input">
									<ng-container *ngIf="!employee?.managerHours; else managerHours">
										<strong
											>{{ employee?.projectHours ? employee.projectHours : 0 }}/<span class="text-gray1">{{
												employee?.normHours ? employee?.normHours : 0
											}}</span></strong
										>
									</ng-container>
									<ng-template #managerHours>
										<strong>
											{{ employee?.managerHours }}/
											<span class="text-gray1">
												{{ employee?.normHours ? employee?.normHours : 0 }}
											</span>
										</strong>
										<span class="text-gray1"> &nbsp;Изменено&nbsp; </span>
										<img src="../../../../../assets/svg/ant-design_info-circle-outlined.svg" alt="info-circle" />
									</ng-template>
								</ng-container>
								<ng-template #input>
									<div>
										<mat-form-field appearance="fill">
											<mat-error *ngIf="hoursGroup.controls['hours_' + employee.id].errors?.min">
												Минимальное значение должно быть не меньше нуля
											</mat-error>
											<mat-error *ngIf="hoursGroup.controls['hours_' + employee.id].errors?.number"> Введите число </mat-error>
											<mat-error *ngIf="hoursGroup.controls['hours_' + employee.id].errors?.max">
												Превышено максимальное значение
											</mat-error>
											<input
												matInput
												[formControlName]="'hours_' + employee?.id"
												ngDefaultControl
												class="text_bold"
											/> </mat-form-field
										>/{{ employee?.normHours ? employee?.normHours : 0 }}
									</div>
								</ng-template>
							</div>
						</td>
						<td class="cell" [ngClass]="{ cell__leaves: employee.leaves?.length! > 1 }">
							<ng-container *ngIf="employee.leaves?.length; else empty">
								<div *ngFor="let leave of employee.leaves" class="cell__leave-label">
									{{ leave.leaveType | leaveLabel }}&nbsp;
									<img src="../../../../../assets/svg/ant-design_info-circle-outlined.svg" alt="info-circle" />
								</div>
							</ng-container>
							<ng-template #empty>
								<span class="text-gray1">{{ '-' }}</span>
							</ng-template>
						</td>
						<td class="cell">
							<p>{{ employee?.projectsCount }}</p>
						</td>
						<td class="cell cell__icon">
							<button mat-icon-button (click)="toggleEditMode(true, employee)">
								<img src="assets/svg/edit.svg" alt="edit" />
							</button>
						</td>
					</tr>
					<tr *ngIf="employee.editMode" class="row">
						<td colspan="5">
							<div class="controls">
								<button mat-button (click)="toggleEditMode(false, employee)" class="controls__button">Отменить</button>
								<button mat-flat-button color="primary" class="controls__button" (click)="onSubmit('submit', employee)">Сохранить</button>
								<button mat-flat-button color='warn' (click)="onSubmit('reset', employee)">Сбросить</button>
							</div>
						</td>
					</tr>
				</ng-container>
			</tbody>
		</table>
	</ng-container>
	<ng-template #loader>
		<div class="loader">
			<mat-spinner></mat-spinner>
		</div>
	</ng-template>
</mat-card>
